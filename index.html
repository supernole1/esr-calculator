<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESR Calculator — Exceptional Scoring Record Check</title>
<meta name="description" content="Check if your golf round triggers an Exceptional Scoring Record (ESR) under USGA GHIN rules.">
<style>
/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green-dark: #2d6a4f;
  --green-mid: #40916c;
  --green-light: #d8f3dc;
  --green-bg: #f0faf4;
  --amber: #f59e0b;
  --amber-light: #fef3c7;
  --amber-border: #d97706;
  --red: #dc2626;
  --red-light: #fee2e2;
  --red-border: #b91c1c;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-700: #374151;
  --gray-900: #111827;
  --white: #ffffff;
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
}

html {
  font-size: 16px;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--green-bg);
  color: var(--gray-900);
  line-height: 1.5;
  min-height: 100vh;
  padding: 0 16px 32px;
}

/* ===== Layout ===== */
.container {
  max-width: 480px;
  margin: 0 auto;
}

/* ===== Header ===== */
header {
  text-align: center;
  padding: 24px 0 8px;
}

header h1 {
  font-size: 1.625rem;
  font-weight: 700;
  color: var(--green-dark);
  letter-spacing: -0.02em;
}

header p {
  font-size: 0.875rem;
  color: var(--gray-500);
  margin-top: 4px;
}

/* ===== Card ===== */
.card {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-top: 16px;
}

/* ===== Form ===== */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 4px;
}

.form-group label .required {
  color: var(--red);
  margin-left: 2px;
}

.form-group label .hint {
  font-weight: 400;
  color: var(--gray-400);
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  background: var(--gray-50);
  color: var(--gray-900);
  transition: border-color 0.15s, box-shadow 0.15s;
  -webkit-appearance: none;
  appearance: none;
}

.form-group select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236b7280' d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--green-mid);
  box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.15);
}

.form-group input.input-error {
  border-color: var(--red);
  box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12);
}

.form-group input[readonly] {
  background: var(--green-light);
  color: var(--green-dark);
  font-weight: 600;
  border-color: var(--green-mid);
  cursor: default;
}

.form-group .error-msg {
  font-size: 0.8125rem;
  color: var(--red);
  margin-top: 4px;
  display: none;
}

.form-group .error-msg.visible {
  display: block;
}

.form-divider {
  border: none;
  border-top: 1px solid var(--gray-200);
  margin: 20px 0;
}

.section-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--gray-400);
  margin-bottom: 12px;
}

/* ===== Search Panel ===== */
#search-panel {
  display: none;
  margin-bottom: 16px;
}

#search-panel.show {
  display: block;
}

.search-status {
  font-size: 0.8125rem;
  color: var(--gray-500);
  padding: 4px 0;
  min-height: 1.5em;
}

.search-status.error {
  color: var(--red);
}

.search-fallback {
  margin-top: 12px;
  padding: 12px;
  background: var(--gray-50);
  border-radius: 8px;
  font-size: 0.8125rem;
  color: var(--gray-700);
  line-height: 1.5;
}

.search-fallback a {
  color: var(--green-dark);
  font-weight: 600;
}

.search-fallback .id-row {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  align-items: center;
}

.search-fallback .id-row input {
  flex: 1;
  padding: 8px 10px;
  font-size: 0.875rem;
  border: 1.5px solid var(--gray-200);
  border-radius: 6px;
  background: var(--white);
}

.search-fallback .id-row button {
  padding: 8px 14px;
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--white);
  background: var(--green-dark);
  border: none;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
  min-height: 36px;
}

/* Loading spinner */
.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid var(--gray-200);
  border-top-color: var(--green-dark);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  vertical-align: middle;
  margin-right: 6px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Selected course badge */
.selected-course {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--green-light);
  border: 1.5px solid var(--green-mid);
  border-radius: 8px;
  margin-bottom: 16px;
}

.selected-course .sc-name {
  font-weight: 600;
  font-size: 0.9375rem;
  color: var(--green-dark);
}

.selected-course .sc-detail {
  font-size: 0.8125rem;
  color: var(--gray-500);
}

.selected-course .sc-updated {
  font-size: 0.6875rem;
  color: var(--gray-400);
  margin-top: 2px;
}

.selected-course .sc-change {
  font-size: 0.8125rem;
  color: var(--green-dark);
  background: none;
  border: none;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  padding: 4px;
  min-height: 44px;
  min-width: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.selected-course .sc-delete {
  color: var(--red);
}

.selected-course .sc-default {
  color: var(--gray-500);
  font-size: 0.75rem;
}

.selected-course .sc-default.is-default {
  color: var(--green-dark);
  text-decoration: none;
  cursor: default;
  font-weight: 600;
}

#selected-course-display {
  display: none;
}

#selected-course-display.show {
  display: flex;
}

/* ===== Buttons ===== */
.btn-row {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 20px;
}

.btn-primary {
  flex: 1;
  padding: 14px 20px;
  font-size: 1rem;
  font-weight: 600;
  color: var(--white);
  background: var(--green-dark);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s;
  min-height: 48px;
  -webkit-appearance: none;
  appearance: none;
}

.btn-primary:hover { background: #245a42; }
.btn-primary:active { background: #1e4d38; }

.btn-reset {
  font-size: 0.9375rem;
  color: var(--gray-500);
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px 4px;
  text-decoration: underline;
  text-underline-offset: 2px;
  min-height: 44px;
  display: flex;
  align-items: center;
}

.btn-reset:hover { color: var(--gray-700); }

/* ===== Result Card ===== */
#results-section {
  display: none;
}

#results-section.show {
  display: block;
}

.result-card {
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  margin-top: 20px;
}

.result-card.no-esr {
  background: var(--green-light);
  border: 2px solid var(--green-mid);
}

.result-card.tier1 {
  background: var(--amber-light);
  border: 2px solid var(--amber-border);
}

.result-card.tier2 {
  background: var(--red-light);
  border: 2px solid var(--red-border);
}

.result-verdict {
  font-size: 1.375rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.no-esr .result-verdict { color: var(--green-dark); }
.tier1 .result-verdict { color: var(--amber-border); }
.tier2 .result-verdict { color: var(--red-border); }

.result-subtitle {
  font-size: 0.9375rem;
  color: var(--gray-700);
  margin-bottom: 16px;
}

.result-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  flex-wrap: wrap;
}

.result-stat {
  text-align: center;
}

.result-stat .stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--gray-900);
}

.result-stat .stat-label {
  font-size: 0.75rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

/* ===== Info Tooltip ===== */
.info-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  border: 1.5px solid currentColor;
  font-size: 0.6875rem;
  font-weight: 700;
  font-style: italic;
  font-family: Georgia, serif;
  cursor: pointer;
  vertical-align: middle;
  margin-left: 3px;
  line-height: 1;
  position: relative;
}

th .info-btn {
  color: var(--white);
}

.stat-label .info-btn {
  color: var(--gray-500);
  background: var(--gray-100);
  border-color: var(--gray-400);
  width: 16px;
  height: 16px;
  font-size: 0.625rem;
}

.info-tooltip {
  display: none;
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: calc(100% - 48px);
  max-width: 340px;
  background: var(--gray-900);
  color: var(--white);
  border-radius: 10px;
  padding: 16px 18px;
  font-size: 0.8125rem;
  line-height: 1.6;
  font-weight: 400;
  text-align: left;
  z-index: 1000;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
}

.info-tooltip.show {
  display: block;
}

.info-tooltip .tt-title {
  font-weight: 700;
  font-size: 0.875rem;
  margin-bottom: 6px;
}

.info-tooltip .tt-formula {
  font-family: "SF Mono", "Menlo", "Consolas", monospace;
  font-size: 0.75rem;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  padding: 8px 10px;
  margin: 8px 0;
  text-align: center;
  word-break: break-word;
  white-space: normal;
}

.info-tooltip .tt-sources {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.15);
  font-size: 0.6875rem;
  color: var(--gray-400);
  line-height: 1.5;
}

.info-tooltip .tt-sources a {
  color: #93c5fd;
  text-decoration: underline;
  text-underline-offset: 2px;
}

.info-tooltip .tt-close {
  display: block;
  text-align: center;
  margin-top: 10px;
  font-size: 0.75rem;
  color: var(--gray-400);
}

.info-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 999;
}

.info-overlay.show {
  display: block;
}

/* ===== Reference Table ===== */
.table-section {
  margin-top: 20px;
}

.table-section h2 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 8px;
  border: 1px solid var(--gray-200);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8125rem;
  white-space: nowrap;
}

thead {
  background: var(--green-dark);
  color: var(--white);
}

th {
  padding: 10px 8px;
  font-weight: 600;
  text-align: center;
}

th:first-child { text-align: left; padding-left: 12px; }

td {
  padding: 8px;
  text-align: center;
  border-bottom: 1px solid var(--gray-200);
}

td:first-child { text-align: left; padding-left: 12px; }

tbody tr:last-child td { border-bottom: none; }

tr.row-current {
  background: var(--green-light);
  font-weight: 700;
}

tr.row-tier1 {
  background: var(--amber-light);
}

tr.row-tier2 {
  background: var(--red-light);
}

tr.row-current.row-tier1 {
  background: linear-gradient(135deg, var(--amber-light), #fde68a);
  font-weight: 700;
}

tr.row-current.row-tier2 {
  background: linear-gradient(135deg, var(--red-light), #fecaca);
  font-weight: 700;
}

.esr-badge {
  display: inline-block;
  font-size: 0.6875rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 4px;
  line-height: 1.3;
}

.esr-badge.badge-none {
  background: var(--gray-100);
  color: var(--gray-500);
}

.esr-badge.badge-tier1 {
  background: var(--amber);
  color: var(--white);
}

.esr-badge.badge-tier2 {
  background: var(--red);
  color: var(--white);
}

/* ===== Footer ===== */
footer {
  text-align: center;
  padding: 24px 0 8px;
  font-size: 0.75rem;
  color: var(--gray-400);
  line-height: 1.6;
}

footer a {
  color: var(--gray-500);
}

/* ===== Animation ===== */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

#results-section.show {
  animation: fadeSlideIn 0.3s ease-out;
}

@media (prefers-reduced-motion: reduce) {
  #results-section.show,
  .spinner {
    animation: none;
  }
}

/* ===== Responsive: wider screens ===== */
@media (min-width: 600px) {
  body { padding: 0 24px 48px; }
  header { padding-top: 40px; }
  header h1 { font-size: 1.875rem; }
  .card { padding: 32px; }
  .result-card { padding: 32px; }
  table { font-size: 0.875rem; }
}

/* ===== Accessibility: focus-visible ===== */
.btn-primary:focus-visible,
.btn-reset:focus-visible,
input:focus-visible,
select:focus-visible {
  outline: 2px solid var(--green-dark);
  outline-offset: 2px;
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <header>
    <h1>ESR Calculator</h1>
    <p>Check if your round triggers an Exceptional Scoring Record</p>
  </header>

  <!-- Input Form -->
  <form id="esr-form" class="card" novalidate>

    <!-- Course & Tee Selection -->
    <div class="section-label">Course</div>

    <div class="form-group">
      <label for="course">Golf Course</label>
      <select id="course">
        <option value="search">Look up on USGA Database...</option>
        <option value="other">Enter manually</option>
      </select>
    </div>

    <!-- Selected Course Badge (shown after USGA search selection) -->
    <div id="selected-course-display" class="selected-course">
      <div style="flex:1;min-width:0">
        <div class="sc-name" id="sc-name"></div>
        <div class="sc-detail" id="sc-detail"></div>
        <div class="sc-updated" id="sc-updated"></div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
        <button type="button" class="sc-change" id="sc-change-btn" aria-label="Change course">Change</button>
        <button type="button" class="sc-change" id="sc-refresh-btn" aria-label="Refresh course data">Refresh</button>
        <button type="button" class="sc-change sc-delete" id="sc-delete-btn" aria-label="Remove course from list">Delete</button>
        <button type="button" class="sc-change sc-default" id="sc-default-btn" aria-label="Set as default course">Set Default</button>
      </div>
    </div>

    <!-- Search Panel (shown when "Search USGA Database..." is selected) -->
    <div id="search-panel">
      <div class="search-fallback" id="search-fallback">
        <strong>Look up your course on the USGA site:</strong>
        <ol style="margin:8px 0 8px 20px;padding:0;font-size:0.8125rem;line-height:1.6">
          <li>Open <a href="https://ncrdb.usga.org/NCRListing" target="_blank" rel="noopener">ncrdb.usga.org</a> and search for your course</li>
          <li>Click your course, then copy the page URL or Course ID</li>
          <li>Paste it below</li>
        </ol>
        <div class="id-row">
          <input type="text" id="course-id-input" inputmode="numeric" placeholder="Paste URL or Course ID (e.g. 31622)" aria-label="Course ID or URL">
          <button type="button" id="course-id-btn">Load</button>
        </div>
      </div>
      <div class="search-status" id="search-status"></div>
    </div>

    <div class="form-group" id="tee-group">
      <label for="tee">Tees</label>
      <select id="tee"></select>
    </div>

    <hr class="form-divider">

    <div class="form-group">
      <label for="courseRating">Course Rating<span class="required">*</span> <span class="hint">(e.g. 71.2)</span></label>
      <input type="text" id="courseRating" inputmode="decimal" autocomplete="off" placeholder="55.0 to 85.0">
      <div class="error-msg" id="courseRating-err"></div>
    </div>

    <div class="form-group">
      <label for="slopeRating">Slope Rating<span class="required">*</span> <span class="hint">(e.g. 128)</span></label>
      <input type="text" id="slopeRating" inputmode="numeric" autocomplete="off" placeholder="55 to 155">
      <div class="error-msg" id="slopeRating-err"></div>
    </div>

    <div class="form-group">
      <label for="par">Par<span class="required">*</span> <span class="hint">(e.g. 72)</span></label>
      <input type="text" id="par" inputmode="numeric" autocomplete="off" placeholder="54 to 80">
      <div class="error-msg" id="par-err"></div>
    </div>

    <div class="form-group">
      <label for="handicapIndex">Handicap Index<span class="required">*</span> <span class="hint">(e.g. 16.3)</span></label>
      <input type="text" id="handicapIndex" inputmode="decimal" autocomplete="off" placeholder="-10.0 to 54.0">
      <div class="error-msg" id="handicapIndex-err"></div>
    </div>

    <div class="form-group">
      <label for="adjGrossScore">Adjusted Gross Score<span class="required">*</span> <span class="hint">(your score)</span></label>
      <input type="text" id="adjGrossScore" inputmode="numeric" autocomplete="off" placeholder="40 to 200">
      <div class="error-msg" id="adjGrossScore-err"></div>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn-primary">Calculate ESR</button>
      <button type="button" class="btn-reset" id="reset-btn">Reset</button>
    </div>
  </form>

  <!-- Results (hidden until calculated) -->
  <div id="results-section" role="region" aria-live="polite" aria-label="Calculation results">
    <div id="result-card" class="result-card">
      <div class="result-verdict" id="result-verdict"></div>
      <div class="result-subtitle" id="result-subtitle"></div>
      <div class="result-stats" id="result-stats"></div>
    </div>

    <div class="table-section">
      <h2>Reference Table</h2>
      <div class="table-wrap">
        <table id="ref-table" aria-label="Score reference table showing ESR status for nearby scores">
          <thead>
            <tr>
              <th scope="col">Score</th>
              <th scope="col">vs Par</th>
              <th scope="col">Diff <button type="button" class="info-btn" data-tooltip="diff-tooltip" aria-label="What is a Score Differential?">i</button></th>
              <th scope="col">HI - Diff</th>
              <th scope="col">ESR <button type="button" class="info-btn" data-tooltip="esr-tooltip" aria-label="What is an Exceptional Scoring Record?">i</button></th>
            </tr>
          </thead>
          <tbody id="ref-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tooltip overlay + popup -->
  <div class="info-overlay" id="info-overlay"></div>
  <div class="info-tooltip" id="diff-tooltip" role="dialog" aria-label="Score Differential explanation">
    <div class="tt-title">Score Differential</div>
    Measures how you played relative to the course difficulty.
    <div class="tt-formula">( Adj. Gross Score - Course Rating ) × 113 / Slope Rating</div>
    A lower differential means a better round. Your Handicap Index is generally the average of the best 8 differentials from your last 20 rounds (fewer differentials are used with fewer rounds on record).
    <div class="tt-sources">
      Sources:
      <a href="https://www.usga.org/content/usga/home-page/handicapping/world-handicap-system/topics/handicap-index-calculation.html" target="_blank" rel="noopener">USGA — Handicap Index Calculation</a>,
      <a href="https://www.usga.org/content/usga/home-page/handicapping/world-handicap-system/world-handicap-system-usga-golf-faqs/faqs---how-is-a-handicap-index-calculated.html" target="_blank" rel="noopener">USGA — Handicap FAQ</a>
    </div>
    <div class="tt-close">Tap anywhere to close</div>
  </div>

  <div class="info-tooltip" id="esr-tooltip" role="dialog" aria-label="Exceptional Scoring Record explanation">
    <div class="tt-title">Exceptional Scoring Record (ESR)</div>
    When your Score Differential is significantly better than your Handicap Index, an automatic reduction kicks in:
    <div class="tt-formula">Gap = Handicap Index - Score Differential</div>
    <strong>Tier 1</strong> — Gap of 7.0 to 9.9: effectively reduces your Handicap Index by <strong>1 stroke</strong>.<br><br>
    <strong>Tier 2</strong> — Gap of 10.0 or more: effectively reduces your Handicap Index by <strong>2 strokes</strong>.<br><br>
    This is applied by adjusting each of your 20 most recent differentials by -1 or -2. The reduction fades naturally as new rounds are posted without the adjustment. Multiple exceptional scores stack.
    <div class="tt-sources">
      Sources:
      <a href="https://www.usga.org/content/usga/home-page/handicapping/world-handicap-system/topics/exceptional-score-reduction.html" target="_blank" rel="noopener">USGA — Exceptional Score Reduction</a>,
      <a href="https://www.usga.org/content/usga/home-page/handicapping/world-handicap-system/world-handicap-system-usga-golf-faqs/faqs---what-is-an-exceptional-score-.html" target="_blank" rel="noopener">USGA — Exceptional Score FAQ</a>
    </div>
    <div class="tt-close">Tap anywhere to close</div>
  </div>

  <!-- Footer -->
  <footer>
    <p>PCC (Playing Conditions Calculation) is a daily USGA adjustment and cannot be predicted in advance. Results shown are pre-PCC.</p>
    <p>Course data from the <a href="https://ncrdb.usga.org" target="_blank" rel="noopener">USGA National Course Rating Database</a>. Not affiliated with the USGA.</p>
  </footer>
</div>

<script>
(function () {
  'use strict';

  // ===== CORS Proxy (for browser-side GET requests) =====
  var PROXY = 'https://corsproxy.io/?';
  var NCRDB = 'https://ncrdb.usga.org';

  // ===== Default Course =====
  var DEFAULT_COURSE_ID = '14208';  // Rocky Bayou CC, Niceville FL

  // Cache for courses fetched from USGA
  var fetchedCourses = {};

  // ===== localStorage Persistence =====
  var STORAGE_KEY = 'esr-saved-courses';
  var DEFAULT_STORAGE_KEY = 'esr-default-course';

  function getDefaultCourseKey() {
    try {
      return localStorage.getItem(DEFAULT_STORAGE_KEY) || 'usga-' + DEFAULT_COURSE_ID;
    } catch (e) { return 'usga-' + DEFAULT_COURSE_ID; }
  }

  function setDefaultCourseKey(key) {
    try {
      localStorage.setItem(DEFAULT_STORAGE_KEY, key);
    } catch (e) { /* storage unavailable */ }
  }

  function saveCourses() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fetchedCourses));
    } catch (e) { /* storage full or unavailable */ }
  }

  function loadSavedCourses() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      var saved = JSON.parse(raw);
      for (var key in saved) {
        if (!saved.hasOwnProperty(key)) continue;
        fetchedCourses[key] = saved[key];
        // Add to dropdown
        var existing = courseSelect.querySelector('option[value="' + key + '"]');
        if (!existing) {
          var opt = document.createElement('option');
          opt.value = key;
          var c = saved[key];
          opt.textContent = c.location ? c.name + ' — ' + c.location : c.name;
          var searchOpt = courseSelect.querySelector('option[value="search"]');
          courseSelect.insertBefore(opt, searchOpt);
        }
      }
    } catch (e) { /* corrupt data or unavailable */ }
  }

  function formatDate(isoString) {
    if (!isoString) return '';
    var d = new Date(isoString);
    if (isNaN(d.getTime())) return '';
    return (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear();
  }

  // ===== DOM References =====

  var courseSelect     = document.getElementById('course');
  var teeSelect        = document.getElementById('tee');
  var teeGroup         = document.getElementById('tee-group');
  var crInput          = document.getElementById('courseRating');
  var slopeInput       = document.getElementById('slopeRating');
  var parInput         = document.getElementById('par');
  var searchPanel      = document.getElementById('search-panel');
  var searchStatus     = document.getElementById('search-status');
  var courseIdInput     = document.getElementById('course-id-input');
  var courseIdBtn       = document.getElementById('course-id-btn');
  var selectedDisplay  = document.getElementById('selected-course-display');
  var scName           = document.getElementById('sc-name');
  var scDetail         = document.getElementById('sc-detail');
  var scChangeBtn      = document.getElementById('sc-change-btn');
  var scRefreshBtn     = document.getElementById('sc-refresh-btn');
  var scDeleteBtn      = document.getElementById('sc-delete-btn');
  var scDefaultBtn     = document.getElementById('sc-default-btn');
  var scUpdated        = document.getElementById('sc-updated');

  // ===== Course/Tee Logic =====

  function getCourseData(courseId) {
    return fetchedCourses[courseId] || null;
  }

  function populateTees(courseId) {
    var course = getCourseData(courseId);
    teeSelect.innerHTML = '';
    if (!course || !course.tees || course.tees.length === 0) return;

    course.tees.forEach(function (t, i) {
      var opt = document.createElement('option');
      opt.value = i;
      var label = t.name;
      if (t.gender) label += ' (' + t.gender + ')';
      label += '  —  ' + t.cr.toFixed(1) + ' / ' + t.slope;
      if (t.yards) label += '  —  ' + t.yards.toLocaleString() + ' yds';
      opt.textContent = label;
      teeSelect.appendChild(opt);
    });

    teeSelect.value = course.defaultTee != null ? course.defaultTee : 0;
  }

  function applyTeeData(courseId) {
    var course = getCourseData(courseId);

    if (!course) {
      // Manual entry mode
      crInput.readOnly = false;
      slopeInput.readOnly = false;
      parInput.readOnly = false;
      crInput.value = '';
      slopeInput.value = '';
      parInput.value = '';
      return;
    }

    var tee = course.tees[teeSelect.value];
    if (!tee) return;

    crInput.value = tee.cr.toFixed(1);
    slopeInput.value = tee.slope;
    parInput.value = tee.par;
    crInput.readOnly = true;
    slopeInput.readOnly = true;
    parInput.readOnly = true;
  }

  // Track currently active course ID
  var activeCourseId = null;

  function setActiveCourse(courseId) {
    activeCourseId = courseId;
    populateTees(courseId);
    applyTeeData(courseId);
  }

  function updateUIForCourseMode(mode) {
    // mode: 'search' | 'fetched' | 'manual'
    searchPanel.classList.remove('show');
    selectedDisplay.classList.remove('show');
    teeGroup.style.display = '';

    if (mode === 'search') {
      searchPanel.classList.add('show');
      teeGroup.style.display = 'none';
      crInput.readOnly = false;
      slopeInput.readOnly = false;
      parInput.readOnly = false;
      crInput.value = '';
      slopeInput.value = '';
      parInput.value = '';
      teeSelect.innerHTML = '';
      courseIdInput.focus();
    } else if (mode === 'fetched') {
      var course = getCourseData(activeCourseId);
      if (course) {
        scName.textContent = course.name;
        scDetail.textContent = course.location || '';
        scUpdated.textContent = course.updatedAt ? 'Updated ' + formatDate(course.updatedAt) : '';
        // Update default button state
        var isDefault = activeCourseId === getDefaultCourseKey();
        scDefaultBtn.textContent = isDefault ? 'Default' : 'Set Default';
        scDefaultBtn.classList.toggle('is-default', isDefault);
        scDefaultBtn.disabled = isDefault;
        selectedDisplay.classList.add('show');
      }
    } else if (mode === 'manual') {
      teeGroup.style.display = 'none';
      crInput.readOnly = false;
      slopeInput.readOnly = false;
      parInput.readOnly = false;
      crInput.value = '';
      slopeInput.value = '';
      parInput.value = '';
      teeSelect.innerHTML = '';
    }
    // 'fetched' default — show tee selector and selected course badge
  }

  // ===== USGA NCRDB Fetch Functions =====

  function proxyFetch(url, options) {
    var proxyUrl = PROXY + encodeURIComponent(url);
    options = options || {};
    return fetch(proxyUrl, options);
  }

  function loadTeeData(courseId, name, detail) {
    proxyFetch(NCRDB + '/courseTeeInfo?CourseID=' + courseId)
      .then(function (res) {
        if (!res.ok) throw new Error('Could not load tee data');
        return res.text();
      })
      .then(function (html) {
        var tees = parseTeeHtml(html);
        if (tees.length === 0) throw new Error('No tee data found');

        // Extract course name and location from the page HTML
        var courseName = name || 'Course ' + courseId;
        var courseLocation = detail || '';

        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');

        // NCRDB page has a header table with td.tableCellWidth for club name,
        // followed by city and state cells
        var nameCell = doc.querySelector('td.tableCellWidth');
        if (nameCell) {
          var extracted = nameCell.textContent.trim();
          if (extracted) courseName = extracted;

          // Get city and state from sibling cells
          var row = nameCell.closest('tr');
          if (row) {
            var cells = row.querySelectorAll('td');
            var city = cells.length > 1 ? cells[1].textContent.trim() : '';
            var state = cells.length > 2 ? cells[2].textContent.trim() : '';
            if (city || state) courseLocation = [city, state].filter(Boolean).join(', ');
          }
        }

        // Pick default tee: prefer "Blue" if available, else first
        var defaultTee = 0;
        for (var ti = 0; ti < tees.length; ti++) {
          if (/^blue$/i.test(tees[ti].name)) { defaultTee = ti; break; }
        }

        // Store in cache with timestamp
        var key = 'usga-' + courseId;
        fetchedCourses[key] = {
          name: courseName,
          location: courseLocation,
          tees: tees,
          defaultTee: defaultTee,
          updatedAt: new Date().toISOString()
        };
        saveCourses();

        // Add to dropdown if not already there
        var existing = courseSelect.querySelector('option[value="' + key + '"]');
        if (!existing) {
          var opt = document.createElement('option');
          opt.value = key;
          opt.textContent = courseLocation ? courseName + ' — ' + courseLocation : courseName;
          // Insert before "Search" option
          var searchOpt = courseSelect.querySelector('option[value="search"]');
          courseSelect.insertBefore(opt, searchOpt);
        } else {
          // Update existing option text in case name/location changed
          existing.textContent = courseLocation ? courseName + ' — ' + courseLocation : courseName;
        }

        // Select the new course
        courseSelect.value = key;
        activeCourseId = key;
        setActiveCourse(key);
        updateUIForCourseMode('fetched');
        clearErrors();
      })
      .catch(function (err) {
        searchStatus.className = 'search-status error';
        searchStatus.textContent = 'Could not load tee data: ' + err.message;
      });
  }

  function parseTeeHtml(html) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    var table = doc.getElementById('gvCourses');
    if (!table) {
      // Fallback: find any table with tee data
      var tables = doc.querySelectorAll('table');
      for (var t = 0; t < tables.length; t++) {
        var th = tables[t].querySelector('th');
        if (th && /tee|rating|slope/i.test(tables[t].textContent)) {
          table = tables[t];
          break;
        }
      }
    }
    if (!table) return [];

    // Find column indices from headers
    var headers = table.querySelectorAll('thead th, thead td, tr:first-child th, tr:first-child td');
    var colMap = {};
    for (var h = 0; h < headers.length; h++) {
      var txt = headers[h].textContent.trim().toLowerCase();
      if (/tee\s*name/i.test(txt) || (h === 0 && /tee/i.test(txt))) colMap.name = h;
      else if (/gender/i.test(txt)) colMap.gender = h;
      else if (/^par$/i.test(txt)) colMap.par = h;
      else if (/course\s*rating/i.test(txt)) colMap.cr = h;
      else if (/^slope\s*rating/i.test(txt)) colMap.slope = h;
      else if (/^length$/i.test(txt)) colMap.length = h;
    }

    // Fallback: assume standard NCRDB column order
    if (colMap.name == null) colMap.name = 0;
    if (colMap.gender == null) colMap.gender = 1;
    if (colMap.par == null) colMap.par = 2;
    if (colMap.cr == null) colMap.cr = 3;
    if (colMap.slope == null) colMap.slope = 5;
    if (colMap.length == null) colMap.length = 15;

    // Parse data rows
    var rows = table.querySelectorAll('tbody tr');
    if (rows.length === 0) {
      // No tbody — skip first row (header) and use remaining
      rows = table.querySelectorAll('tr');
      rows = Array.prototype.slice.call(rows, 1);
    }

    var tees = [];
    for (var r = 0; r < rows.length; r++) {
      var cells = rows[r].querySelectorAll('td');
      if (cells.length < 6) continue;

      var teeName = (cells[colMap.name] || {}).textContent || '';
      teeName = teeName.trim();
      if (!teeName) continue;

      var gender = (cells[colMap.gender] || {}).textContent || '';
      gender = gender.trim().toUpperCase();

      var par = parseInt((cells[colMap.par] || {}).textContent, 10);
      var cr  = parseFloat((cells[colMap.cr] || {}).textContent);
      var slope = parseInt((cells[colMap.slope] || {}).textContent, 10);
      var yards = parseInt((cells[colMap.length] || {}).textContent, 10);

      if (isNaN(par) || isNaN(cr) || isNaN(slope)) continue;

      tees.push({
        name: teeName,
        gender: gender || null,
        cr: cr,
        slope: slope,
        par: par,
        yards: isNaN(yards) ? null : yards
      });
    }

    return tees;
  }

  // ===== Event Handlers: Course Selection =====

  courseSelect.addEventListener('change', function () {
    var val = this.value;

    if (val === 'search') {
      updateUIForCourseMode('search');
    } else if (val === 'other') {
      activeCourseId = null;
      updateUIForCourseMode('manual');
    } else {
      activeCourseId = val;
      setActiveCourse(val);
      updateUIForCourseMode('fetched');
    }
    clearErrors();
  });

  teeSelect.addEventListener('change', function () {
    if (activeCourseId) applyTeeData(activeCourseId);
    clearErrors();
  });

  // Course ID direct lookup — supports pasted URLs or plain IDs
  function extractCourseId(input) {
    input = input.trim();
    // Try to extract CourseID from a URL like ncrdb.usga.org/...?CourseID=31622
    var urlMatch = input.match(/CourseID[=:](\d+)/i);
    if (urlMatch) return urlMatch[1];
    // Also match ncrdb.usga.org/NCRCourse/... pattern
    var pathMatch = input.match(/NCRCourse\/(\d+)/i);
    if (pathMatch) return pathMatch[1];
    // Plain number
    if (/^\d+$/.test(input)) return input;
    return null;
  }

  courseIdBtn.addEventListener('click', function () {
    var raw = courseIdInput.value.trim();
    var id = extractCourseId(raw);
    if (!id) {
      courseIdInput.classList.add('input-error');
      return;
    }
    courseIdInput.classList.remove('input-error');
    searchStatus.innerHTML = '<span class="spinner"></span>Loading tee data...';
    loadTeeData(id, null, null);
  });

  courseIdInput.addEventListener('input', function () {
    this.classList.remove('input-error');
  });

  courseIdInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      courseIdBtn.click();
    }
  });

  // "Change" button on selected course badge
  scChangeBtn.addEventListener('click', function () {
    courseSelect.value = 'search';
    updateUIForCourseMode('search');
  });

  // "Refresh" button — re-fetch current course from USGA
  scRefreshBtn.addEventListener('click', function () {
    if (!activeCourseId) return;
    var courseId = activeCourseId.replace(/^usga-/, '');
    searchStatus.innerHTML = '<span class="spinner"></span>Refreshing course data...';
    loadTeeData(courseId, null, null);
  });

  // "Delete" button — remove course from saved list
  scDeleteBtn.addEventListener('click', function () {
    if (!activeCourseId) return;
    var keyToDelete = activeCourseId;

    // Remove from cache and localStorage
    delete fetchedCourses[keyToDelete];
    saveCourses();

    // If deleted course was the default, reset default to Rocky Bayou
    if (getDefaultCourseKey() === keyToDelete) {
      setDefaultCourseKey('usga-' + DEFAULT_COURSE_ID);
    }

    // Remove dropdown option
    var opt = courseSelect.querySelector('option[value="' + keyToDelete + '"]');
    if (opt) opt.remove();

    // Switch to another course: prefer the default, then first available, then search
    var nextKey = getDefaultCourseKey();
    if (!fetchedCourses[nextKey]) {
      // Find first available course in dropdown
      nextKey = null;
      for (var k in fetchedCourses) {
        if (fetchedCourses.hasOwnProperty(k)) { nextKey = k; break; }
      }
    }

    if (nextKey && fetchedCourses[nextKey]) {
      courseSelect.value = nextKey;
      activeCourseId = nextKey;
      setActiveCourse(nextKey);
      updateUIForCourseMode('fetched');
    } else {
      // No courses left — show search panel
      activeCourseId = null;
      courseSelect.value = 'search';
      updateUIForCourseMode('search');
    }
  });

  // "Set Default" button — make current course the default on load
  scDefaultBtn.addEventListener('click', function () {
    if (!activeCourseId) return;
    if (activeCourseId === getDefaultCourseKey()) return;
    setDefaultCourseKey(activeCourseId);
    // Update button to show it's now the default
    scDefaultBtn.textContent = 'Default';
    scDefaultBtn.classList.add('is-default');
    scDefaultBtn.disabled = true;
  });

  // Initialize — load saved courses from localStorage, then fetch default if needed
  loadSavedCourses();
  var defaultKey = getDefaultCourseKey();
  if (fetchedCourses[defaultKey]) {
    // Use cached data — no network fetch needed
    courseSelect.value = defaultKey;
    activeCourseId = defaultKey;
    setActiveCourse(defaultKey);
    updateUIForCourseMode('fetched');
  } else {
    // Extract numeric ID from key (e.g. "usga-14208" -> "14208")
    var initCourseId = defaultKey.replace(/^usga-/, '');
    loadTeeData(initCourseId, null, null);
  }

  // ===== Pure Calculation Functions =====

  function calcDifferential(ags, courseRating, slopeRating) {
    var raw = (ags - courseRating) * 113 / slopeRating;
    return Math.round(raw * 10) / 10;
  }

  function calcCourseHandicap(hi, slopeRating, courseRating, par) {
    var raw = hi * (slopeRating / 113) + (courseRating - par);
    return Math.round(raw);
  }

  function calcESR(hi, differential) {
    var gap = Math.round((hi - differential) * 10) / 10;
    if (gap >= 10.0) {
      return { tier: 2, gap: gap, adjustment: -2 };
    } else if (gap >= 7.0) {
      return { tier: 1, gap: gap, adjustment: -1 };
    }
    return { tier: 0, gap: gap, adjustment: 0 };
  }

  function formatVsPar(score, par) {
    var diff = score - par;
    if (diff === 0) return 'E';
    return diff > 0 ? '+' + diff : String(diff);
  }

  // ===== Validation =====

  var fields = [
    { id: 'handicapIndex', label: 'Handicap Index', min: -10, max: 54, decimal: true },
    { id: 'courseRating',  label: 'Course Rating',  min: 55,  max: 85, decimal: true },
    { id: 'slopeRating',  label: 'Slope Rating',   min: 55,  max: 155, decimal: false },
    { id: 'par',           label: 'Par',             min: 54,  max: 80,  decimal: false },
    { id: 'adjGrossScore', label: 'Adj. Gross Score', min: 40,  max: 200, decimal: false }
  ];

  function validateAll() {
    var values = {};
    var valid = true;

    fields.forEach(function (f) {
      var input = document.getElementById(f.id);
      var errEl = document.getElementById(f.id + '-err');
      var raw = input.value.trim();

      input.classList.remove('input-error');
      errEl.textContent = '';
      errEl.classList.remove('visible');

      if (raw === '') {
        showError(input, errEl, f.label + ' is required.');
        valid = false;
        return;
      }

      var num = parseFloat(raw);
      if (isNaN(num)) {
        showError(input, errEl, 'Enter a valid number.');
        valid = false;
        return;
      }

      if (!f.decimal && num !== Math.floor(num)) {
        showError(input, errEl, f.label + ' must be a whole number.');
        valid = false;
        return;
      }

      if (num < f.min || num > f.max) {
        showError(input, errEl, 'Must be between ' + f.min + ' and ' + f.max + '.');
        valid = false;
        return;
      }

      values[f.id] = num;
    });

    return valid ? values : null;
  }

  function showError(input, errEl, msg) {
    input.classList.add('input-error');
    errEl.textContent = msg;
    errEl.classList.add('visible');
  }

  function clearErrors() {
    fields.forEach(function (f) {
      var input = document.getElementById(f.id);
      var errEl = document.getElementById(f.id + '-err');
      input.classList.remove('input-error');
      errEl.textContent = '';
      errEl.classList.remove('visible');
    });
  }

  // ===== Result Rendering =====

  function renderResult(vals) {
    var hi = vals.handicapIndex;
    var cr = vals.courseRating;
    var slope = vals.slopeRating;
    var par = vals.par;
    var ags = vals.adjGrossScore;

    var differential = calcDifferential(ags, cr, slope);
    var courseHcp = calcCourseHandicap(hi, slope, cr, par);
    var esr = calcESR(hi, differential);

    var section = document.getElementById('results-section');
    var card = document.getElementById('result-card');
    var verdict = document.getElementById('result-verdict');
    var subtitle = document.getElementById('result-subtitle');
    var stats = document.getElementById('result-stats');

    card.className = 'result-card';

    if (esr.tier === 0) {
      card.classList.add('no-esr');
      verdict.textContent = 'No ESR Triggered';
      subtitle.textContent = 'This round does not trigger an Exceptional Scoring Record.';
    } else if (esr.tier === 1) {
      card.classList.add('tier1');
      verdict.textContent = 'ESR — Tier 1';
      subtitle.textContent = 'A -1 adjustment will be applied to your 20 most recent differentials.';
    } else {
      card.classList.add('tier2');
      verdict.textContent = 'ESR — Tier 2';
      subtitle.textContent = 'A -2 adjustment will be applied to your 20 most recent differentials.';
    }

    stats.innerHTML =
      '<div class="result-stat"><div class="stat-value">' + differential.toFixed(1) + '</div><div class="stat-label">Differential <button type="button" class="info-btn" data-tooltip="diff-tooltip" aria-label="What is a Score Differential?">i</button></div></div>' +
      '<div class="result-stat"><div class="stat-value">' + courseHcp + '</div><div class="stat-label">Course Hcp</div></div>' +
      '<div class="result-stat"><div class="stat-value">' + esr.gap.toFixed(1) + '</div><div class="stat-label">HI - Diff</div></div>';

    renderTable(hi, cr, slope, par, ags);

    section.classList.remove('show');
    void section.offsetWidth;
    section.classList.add('show');

    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function renderTable(hi, cr, slope, par, ags) {
    var tbody = document.getElementById('ref-tbody');
    tbody.innerHTML = '';

    var lowScore = ags - 10;
    var highScore = ags + 5;

    for (var s = lowScore; s <= highScore; s++) {
      var diff = calcDifferential(s, cr, slope);
      var esr = calcESR(hi, diff);

      var tr = document.createElement('tr');

      if (s === ags) tr.classList.add('row-current');
      if (esr.tier === 1) tr.classList.add('row-tier1');
      if (esr.tier === 2) tr.classList.add('row-tier2');

      var badgeClass, badgeText;
      if (esr.tier === 0) {
        badgeClass = 'badge-none';
        badgeText = 'None';
      } else if (esr.tier === 1) {
        badgeClass = 'badge-tier1';
        badgeText = 'Tier 1';
      } else {
        badgeClass = 'badge-tier2';
        badgeText = 'Tier 2';
      }

      tr.innerHTML =
        '<td>' + s + (s === ags ? ' *' : '') + '</td>' +
        '<td>' + formatVsPar(s, par) + '</td>' +
        '<td>' + diff.toFixed(1) + '</td>' +
        '<td>' + esr.gap.toFixed(1) + '</td>' +
        '<td><span class="esr-badge ' + badgeClass + '">' + badgeText + '</span></td>';

      tbody.appendChild(tr);
    }
  }

  // ===== Form Event Handlers =====

  var form = document.getElementById('esr-form');
  var resetBtn = document.getElementById('reset-btn');

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    var vals = validateAll();
    if (vals) {
      renderResult(vals);
    }
  });

  resetBtn.addEventListener('click', function () {
    // Reset to user's default course
    var resetKey = getDefaultCourseKey();
    if (fetchedCourses[resetKey]) {
      courseSelect.value = resetKey;
      activeCourseId = resetKey;
      setActiveCourse(resetKey);
      updateUIForCourseMode('fetched');
    } else {
      // If default wasn't loaded yet, reload it
      var resetId = resetKey.replace(/^usga-/, '');
      courseSelect.value = 'search';
      updateUIForCourseMode('search');
      loadTeeData(resetId, null, null);
    }

    document.getElementById('handicapIndex').value = '';
    document.getElementById('adjGrossScore').value = '';

    searchStatus.textContent = '';
    courseIdInput.value = '';

    clearErrors();
    document.getElementById('results-section').classList.remove('show');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Clear error on input
  fields.forEach(function (f) {
    document.getElementById(f.id).addEventListener('input', function () {
      var errEl = document.getElementById(f.id + '-err');
      this.classList.remove('input-error');
      errEl.textContent = '';
      errEl.classList.remove('visible');
    });
  });

  // ===== Info Tooltips =====

  var overlay = document.getElementById('info-overlay');

  function showTooltip(id) {
    var tip = document.getElementById(id);
    if (!tip) return;
    overlay.classList.add('show');
    tip.classList.add('show');
  }

  function hideAllTooltips() {
    overlay.classList.remove('show');
    var tips = document.querySelectorAll('.info-tooltip.show');
    for (var i = 0; i < tips.length; i++) {
      tips[i].classList.remove('show');
    }
  }

  // Delegate click on info buttons (handles dynamically created ones too)
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('.info-btn');
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      showTooltip(btn.dataset.tooltip);
      return;
    }
    // Close on overlay or tooltip click
    if (e.target.closest('.info-overlay') || e.target.closest('.info-tooltip')) {
      hideAllTooltips();
    }
  });

})();
</script>

</body>
</html>
